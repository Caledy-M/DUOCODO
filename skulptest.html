<html>
    <head>
        <script src="./skulpt/skulpt.min.js" type="text/javascript"></script> 
        <script src="./skulpt/skulpt-stdlib.js" type="text/javascript"></script> 
        <meta charset="UTF-8">
    </head>
    <body>
        <textarea id="input" cols="40" rows="10">a = 7
b = 8
print (a+b)</textarea>
        <div id="output"></div>
        <script type="text/javascript">

            var testVariables = [
            {
                name: "a",
                value: 0
            },
            {
                name: "b",
                value: 0
            }];

            console.log("Variables avant exécution:");
            console.log(testVariables);

            function skulpt(python, variables=null, errorCallback=null)
            {
                var skulptOutput = "";

                function outf(text) // Run once every line
                {
                    skulptOutput += text;
                }

                function successCallback(mod)
                {

                }

                if (errorCallback == null) errorCallback = defaultErrorCallback;
                function defaultErrorCallback(err)
                {
                    console.log(err.toString());
                }

                function process(code) 
                { 
                    Sk.configure({output:outf}); 

                    var skulptPromise = Sk.misceval.asyncToPromise(
                        function() { return Sk.importMainWithBody("<stdin>", false, code, false); }
                    );
                    skulptPromise.then(successCallback, errorCallback);
                }

                // Add code that will interrogate the interpreter about the state of specific variables
                var input = python;
                if (variables != null)
                {
                    for (i=0; i<variables.length; i++)
                    {
                        // Abort if "variables" isn’t formatted properly
                        if (variables[i].name == null) 
                        { 
                            console.error("Function skulpt(): Second argument contains objects without a \"name\" field).");
                            return;
                        }
                        input += "\nprint(" + variables[i].name + ")";
                    }
                }

                // Interpret the code
                process(input);

                // Parse the output to retrieve the value of our variables
                if (variables != null)
                {
                    let size = skulptOutput.length;
                    //console.log(variables);
                    
                    for (i=1; i<=variables.length; i++)
                    {
                        variables[variables.length -i].value = skulptOutput[size-i*2];
                    }
                    
                    // Cut the output 
                    skulptOutput = skulptOutput.slice(0, skulptOutput.length - variables.length * 2);
                }



                return skulptOutput;
            }

            // DEBUG
            /*
            console.log("======");
            console.log(skulpt("print(\"Hello World\")\na=7\nb=3", testVariables));
            console.log("======");

            */

            

            function tryIt()
            {
                document.getElementById("output").innerHTML = skulpt(document.getElementById("input").value, testVariables);
                console.log("Variables après exécution:")
                console.log(testVariables);
            }
        </script>
        <button type="button" onclick="tryIt()">Run</button> 
    </body>
</html>